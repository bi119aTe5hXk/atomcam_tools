From d3b0cf5220a114a5d593e4d4cde047efa0db22bd Mon Sep 17 00:00:00 2001
From: Mitsuru Nakada <mitsuru.nakada@sony.com>
Date: Wed, 15 May 2024 22:57:02 +0900
Subject: [PATCH] HomeKit still image - JPEG stream can be passed to HomeKit.

---
 internal/homekit/homekit.go | 2 ++
 internal/homekit/server.go  | 7 ++++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/internal/homekit/homekit.go b/internal/homekit/homekit.go
index 86a5d4b..1bb4c5f 100644
--- a/internal/homekit/homekit.go
+++ b/internal/homekit/homekit.go
@@ -27,6 +27,7 @@ func Init() {
 			DeviceID      string   `yaml:"device_id"`
 			DevicePrivate string   `yaml:"device_private"`
 			SetupID       string   `yaml:"setup_id"`
+			Image         string   `yaml:"image_stream"`
 			Pairings      []string `yaml:"pairings"`
 		} `yaml:"homekit"`
 	}
@@ -69,6 +70,7 @@ func Init() {
 
 		srv := &server{
 			stream:   id,
+			image:    conf.Image,
 			srtp:     srtp.Server,
 			pairings: conf.Pairings,
 		}
diff --git a/internal/homekit/server.go b/internal/homekit/server.go
index cb114fe..958bbe7 100644
--- a/internal/homekit/server.go
+++ b/internal/homekit/server.go
@@ -25,6 +25,7 @@ import (
 
 type server struct {
 	stream    string      // stream name from YAML
+	image     string
 	hap       *hap.Server // server for HAP connection and encryption
 	mdns      *mdns.ServiceEntry
 	srtp      *srtp.Server
@@ -142,7 +143,11 @@ func (s *server) SetCharacteristic(conn net.Conn, aid uint8, iid uint64, value a
 func (s *server) GetImage(conn net.Conn, width, height int) []byte {
 	log.Trace().Msgf("[homekit] %s: get image width=%d height=%d", conn.RemoteAddr(), width, height)
 
-	stream := streams.Get(s.stream)
+	streamId := s.stream
+	if(s.image != "") {
+		streamId = s.image
+	}
+	stream := streams.Get(streamId)
 	cons := magic.NewKeyframe()
 
 	if err := stream.AddConsumer(cons); err != nil {
-- 
2.39.3 (Apple Git-146)

